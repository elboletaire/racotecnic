<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Subida de ficheros en CakePHP 1.2 con uploadify y jQuery &#8211; Racó Tècnic</title>
<meta name="description" content="Punt de trobada de coneixements">
<meta name="keywords" content="PHP, jQuery, CakePHP, Uploadify">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="//elboletaire.github.io/racotecnic/images/">
<meta name="twitter:title" content="Subida de ficheros en CakePHP 1.2 con uploadify y jQuery">
<meta name="twitter:description" content="Punt de trobada de coneixements">
<meta name="twitter:creator" content="@racotecnic">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Subida de ficheros en CakePHP 1.2 con uploadify y jQuery">
<meta property="og:description" content="Punt de trobada de coneixements">
<meta property="og:url" content="//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/">
<meta property="og:site_name" content="Racó Tècnic">





<link rel="canonical" href="//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/">
<link href="//elboletaire.github.io/racotecnic/feed.xml" type="application/atom+xml" rel="alternate" title="Racó Tècnic Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="//elboletaire.github.io/racotecnic/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="//elboletaire.github.io/racotecnic/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="//elboletaire.github.io/racotecnic/assets/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="//elboletaire.github.io/racotecnic/assets/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="//elboletaire.github.io/racotecnic/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="//elboletaire.github.io/racotecnic/images/" alt="Racó Tècnic photo" class="author-photo">
					<h4>Racó Tècnic</h4>
					<p>A subproject from <a href="http://underave.net">underave.net</a> created by <a href="https://github.com/elboletaire">elboletaire</a> and maintained by many collaborators.</p>
				</li>
				<li><a href="//elboletaire.github.io/racotecnic/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:elboletaire@underave.net"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/racotecnic"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/racotecnic"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				
				<li>
					<a href="https://github.com/elboletaire/racotecnic"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="//elboletaire.github.io/racotecnic/posts/">All Posts</a></li>
				<li><a href="//elboletaire.github.io/racotecnic/tags/">All Tags</a></li>
				<li><a href="//elboletaire.github.io/racotecnic/categories/">All Categories</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="https://github.com/elboletaire/racotecnic" target="_blank">Github</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/" rel="bookmark" title="Subida de ficheros en CakePHP 1.2 con uploadify y jQuery">Subida de ficheros en CakePHP 1.2 con uploadify y jQuery</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2009-06-12T00:52:32+02:00">June 12, 2009</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~28 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <blockquote>
  <em>Entrada actualizada a 18 de junio de 2009. Los cambios son desde <a href="#ampliacio">aquí</a></em>
  <b>Existe una entrada más reciente relacionada con este tema: <a href="/2009/10/subida-de-ficheros-con-uploadify-y-validacion-ajax-en-cakephp/" target="_top">Subida de ficheros con Uploadify y validación Ajax en CakePHP</a></b>
</blockquote>

<p>Después de mucho tiempo liado con el fin de curso y tras mucho investigar con CakePHP por fin escribo algo al respecto. Para los que no lo sepáis, <strong>CakePHP</strong> es un <a title="Definición de framework" href="http://es.wikipedia.org/wiki/Framework" target="_blank"><em>framework</em></a> de PHP que nos permite programar más rápido nuestras aplicaciones web PHP ya que nos ofrece las herramientas para que empecemos a escribir el código que realmente necesitamos: la lógica de la aplicación.</p>

<p>Si no conocíais CakePHP y os ha interesado el tema echad un ojo a <a title="Visitar web de CakePHP" href="http://www.cakephp.org" target="_blank">su página web</a>, <a title="Descargas de CakePHP" href="http://cakephp.org/downloads" target="_blank">descargaos una copia</a> y empezad a hacer pruebas. En su web podréis encontrar la <a title="Comenzando con CakePHP" href="http://book.cakephp.org/es/view/4/Comenzando-con-CakePHP" target="_blank">mayor parte de la documentación</a> y todo lo demás, como no, en <a title="Realmente hacía falta enlazarlo?" href="http://www.google.es" target="_blank">google</a>.</p>

<p>En este artículo explicaré cómo integrar <a title="Página web oficial de uploadify" href="http://www.uploadify.com/" target="_blank">uploadify</a>, un sistema de carga de ficheros con Flash y JavaScript (utilizando el <em>framework</em> <a title="Página web oficial de jQuery" href="http://jquery.com/" target="_blank">jQuery</a>) a CakePHP para permitirnos cargar múltiples ficheros sin tener que refrescar la página, así como poder cargar ficheros de gran tamaño.</p>

<p><a id="more"></a><a id="more-617"></a>
Antes de empezar, sobreentiendo que tenéis conocimientos sobre CakePHP, así como que habéis utilizado algún sistema de carga de ficheros con flash, tipo <a title="Página web oficial de uploadify" href="http://www.uploadify.com/" target="_blank">uploadify</a> o <a title="Página web oficial de swfUpload" href="http://swfupload.org/" target="_blank">swfupload</a> alguna vez en vuestra vida (aunque no haya sido con Cake). Tampoco estaría de más tener conocimientos de jQuery, para poder gestionar las subidas de ficheros de forma asíncrona. También asumo que ya tenéis CakePHP funcionando en algun servidor.</p>

<p>Dicho esto, empecemos…</p>

<p>Descargamos la última versión de <a title="jQuery downloads" href="http://code.google.com/p/jqueryjs/downloads/list" target="_blank">jQuery</a> (en mi caso la <a title="jQuery 1.3.2 minified" href="http://jqueryjs.googlecode.com/files/jquery-1.3.2.min.js" target="_blank">v. 1.3.2</a>) y copiamos o movemos el fichero JavaScript a nuestro directorio de ficheros JavaScript, situado en la carpeta <em>webroot</em> (en <em>/app/webroot/js</em>).</p>

<p>Descargamos la última versión de <a title="Descargar uploadify" href="http://www.uploadify.com/download/" target="_blank">uploadify</a> (en mi caso la <a title="uploadify v 1.6.2. GPL" href="http://www.uploadify.com/_files/jquery.uploadify-v1.6.2.zip" target="_self">v. 1.6.2 GPL</a>). Al descargar uploadify nos daremos cuenta que el paso anterior ha sido inútil dado que en la carpeta de uploadify ya viene jQuery :p estos fallos los tiene cualquiera… u.u</p>

<p>De la carpeta de uploadify nos interesan los siguientes ficheros:</p>

<ul>
  <li>cancel.png</li>
  <li>jquery.uploadify.js</li>
  <li>uploader.swf</li>
  <li>uploadify.css</li>
</ul>

<p>el resto eliminadlos (para lo que haremos no son necesarios, no obstante recomiendo que echéis un vistazo a todo ello). Renombrad la carpeta a “uploadify” y movedla dentro del directorio de JavaScripts de <em>webroot</em> (<em>app/webroot/js</em>). Opcionalmente podéis copiar el código del fichero <em>uploadify.css</em> a vuestro fichero css si lo preferís, de este modo podríais descartar también el fichero <em>uploadify.css</em> que apenas contiene 20 líneas.</p>

<p>Ahora que ya tenemos todos los JavaScripts necesarios, pasemos a la parte de los controladores y las vistas.</p>

<p>Para gestionar la subida de ficheros necesitaréis un <em>Component</em> (o bien programar toda la gestión de ficheros “a pelo” en vuestros controladores). Yo he utilizado <em>“<a title="Image Upload Component para CakePHP" href="http://labs.iamkoa.net/2007/10/23/image-upload-component-cakephp/" target="_blank">Image Upload Component</a>”</em>, que además de gestionarme la carga de cualquier tipo de fichero me permite recortar imágenes, generar miniaturas y otras acciones relacionadas con imágenes. <a title="Descargar upload component" href="http://iamkoa.net/mint/pepper/orderedlist/downloads/download.php?file=http%3A//labs.iamkoa.net/wp-content/uploads/2007/11/uploads-component-11062007.zip" target="_blank">Una vez descargado</a> el <em>Upload Component</em> nos quedamos con el fichero <strong><em>upload.php</em></strong> que hay dentro del directorio <em>/app/controllers/components</em> y lo copiamos en este mismo directorio, pero de nuestro proyecto.</p>

<p>Aquí viene el código del controlador, en mi caso “images_controller”:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">ImagesController</span> <span class="k">extends</span> <span class="nx">AppController</span>
<span class="p">{</span>
  <span class="k">var</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'Images'</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Upload'</span><span class="p">);</span>
  <span class="k">var</span> <span class="nv">$helpers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Uploadify'</span><span class="p">);</span>

  <span class="k">function</span> <span class="nf">beforeFilter</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Si la acción es subir ficheros
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">action</span> <span class="o">==</span> <span class="s1">'upload'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">][</span><span class="mi">0</span><span class="p">])){</span>
        <span class="c1">// Iniciamos la sesión con el id de sesión pasado como parámetro
</span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">'pass'</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">start</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Cargamos el beforeFilter superior (en AppController o Controller)
</span>    <span class="k">parent</span><span class="o">::</span><span class="na">beforeFilter</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">upload</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Desactivamos el rendering de la vista para este método
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">autoRender</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">'form'</span><span class="p">][</span><span class="s1">'Filedata'</span><span class="p">]))</span> <span class="p">{</span>
      <span class="c1">// Creamos una miniatura
</span>      <span class="nv">$thumb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">'form'</span><span class="p">][</span><span class="s1">'Filedata'</span><span class="p">],</span><span class="s1">'img/thumb/'</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'resizecrop'</span><span class="p">,</span> <span class="s1">'size'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'150'</span><span class="p">,</span> <span class="s1">'150'</span><span class="p">),</span> <span class="s1">'output'</span> <span class="o">=&gt;</span> <span class="s1">'jpg'</span><span class="p">));</span>
      <span class="c1">// Si no se crea correctamente
</span>      <span class="k">if</span> <span class="p">(</span><span class="nv">$thumb</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Generamos un log con los errores
</span>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s1">'L\'usuari '</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span> <span class="o">.</span>
          <span class="s1">' ha tingut errors intentant crear una miniatura: '</span> <span class="o">.</span>
          <span class="nb">implode</span><span class="p">(</span><span class="s1">' | '</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">),</span><span class="s1">'upload'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Si la miniatura se ha creado subimos el fichero a tamaño original
</span>        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">upload</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">params</span><span class="p">[</span><span class="s1">'form'</span><span class="p">][</span><span class="s1">'Filedata'</span><span class="p">],</span><span class="s1">'img/'</span><span class="p">,</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">result</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// Si la imagen se sube correctamente enviamos el nombre de ésta al usuario
</span>          <span class="k">echo</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">result</span><span class="p">;</span>
          <span class="k">exit</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="c1">// En caso contrario generamos un log de error
</span>          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">log</span><span class="p">(</span><span class="s1">'L\'usuari '</span> <span class="o">.</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">'username'</span><span class="p">)</span> <span class="o">.</span>
            <span class="s1">' ha tingut errors intentant pujar una imatge: '</span> <span class="o">.</span>
            <span class="nb">implode</span><span class="p">(</span><span class="s1">' | '</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Upload</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">),</span><span class="s1">'upload'</span><span class="p">);</span>
          <span class="k">echo</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Error pujant el fitxer'</span><span class="p">);</span>
          <span class="k">exit</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">add</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="c1">// Guardamos los datos en la base de datos
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Image</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Si no entendéis algo podéis referiros a la <a href="http://api.cakephp.org" target="_blank" title="Ir a la API">api</a> y al <a href="http://book.cakephp.org" target="_blank" title="Ir al libro de recetas de Cake">libro de recetas</a> de Cake o, en caso de ser con la generación de imágenes a la ayuda del <a title="Image Upload Component para CakePHP" href="http://labs.iamkoa.net/2007/10/23/image-upload-component-cakephp/" target="_blank">Image Upload Component</a>.</p>

<p>Como podéis ver he instanciado un <em>helper</em> que se llama “Uploadify”. Lo he creado yo para insertar el código JavaScript de uploadify en las vistas y si lo queréis lo podéis descargar desde <a href="//elboletaire.github.io/racotecnic/uploads/2009/06/uploadify_helper.zip">aquí</a>. Cuando llegue el momento de explicar las vistas pondré los ejemplos utilizando el código convencional y el código del <em>helper</em>.</p>

<p>Siguiendo con el controlador “images_controller”, el <em>beforeFilter</em> se encarga de iniciar la sesión en caso de que ésta no exista, a partir de un ID que le pasaremos desde la vista como primer parámetro. Sin estas líneas en que se inicia la sesión de nuevo seguramente tendríais problemas al enviar el fichero; éste se enviaría pero al llegar al 100% os daría un IO error (en mac y linux) o bien os incrustará la ventana de login por ahí en medio (en windows). Una vez iniciada la sesión se llama al <em>beforeFilter</em> superior para realizar las tareas pertinentes.</p>

<p>Las tareas del método upload están descritas en los comentarios y no creo que haga falta entrar en más detalles. Para más detalles, como he dicho antes, dirigíos a la ayuda de Cake o del Image Upload Component.</p>

<p>En el método add() hacemos las tareas necesarias para guardar los datos.</p>
<blockquote>
<em>**Nota:** El envío de ficheros debéis hacerlo al mismo controlador. Si intentáis hacer un envío de ficheros desde el controlador "images" al controlador "files" (por ejemplo), NO FUNCIONARÁ. No sé porqué, así que si alguien encuentra el modo de hacerlo o sabe porqué pasa agradecería que me lo comentara por aquí.</em></blockquote>

<p>Ya tenemos el controlador con su componente, ahora nos quedan únicamente la vista, pero antes explicaré cómo funciona el helper que he creado para aquellos que quieran utilizarlo…</p>

<p>Primero decir que es la primera “versión” (si es que se le puede llamar así), así que veréis que hay algún fallo o cosa sin terminar. Con el tiempo quizás lo mejore, aunque por el momento me funciona perfectamente tal como está.</p>

<p>Una vez iniciado el <em>helper</em> en el controlador únicamente tenéis que llamar a la función “<em>startUploader</em>” de dicho <em>helper</em>. Como primer parámetro debéis pasar un array asociativo con el id de la capa del uploader como clave y el directorio destino como valor de la clave. Lamentablemente el directorio de destino no está implementado en este ejemplo, pero utilizando un poco la cabeza seguro que podréis descubrir cómo utilizarlo ;).</p>

<p>Como segundo parámetro se le pasa un array, también asociativo, con las opciones de uploadify (que podéis mirar desde <a href="http://www.uploadify.com/documentation/" target="_blank" title="Ver documentación de uploadify">aquí</a>). El tercer parámetro es por si ponéis varios uploadify en una misma página, para no volver a cargar los ficheros JavaScript y css; pasadle como parámetro “false” a partir del segundo uploader que añadáis.</p>

<p>Aquí tenéis el código que he utilizado para la vista:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="nt">&lt;h2&gt;</span><span class="cp">&lt;?php</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Pujar imatges'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/h2&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'Image'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'add'</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'imageFile'</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Necessites JavaScript i Flash per poder pujar fitxers'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'uploaded'</span> <span class="na">style=</span><span class="s">'display:none'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">'files'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Guardar'</span><span class="p">,</span><span class="kc">true</span><span class="p">));</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="na">link</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Enviar'</span><span class="p">,</span><span class="kc">true</span><span class="p">),</span><span class="s1">'javascript:$(\'#imageFile\').fileUploadStart()'</span><span class="p">);</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span> <span class="cp">?&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Como veis he creado un formulario que envía a la acción <em>add</em> del controlador. Dentro de este he creado una primera capa donde se cargará uploadify (con la id “imageFile”) seguida de una capa donde irán apareciendo las imágenes (en la capa “files” para ser más exactos) que se vayan subiendo. Esta capa está oculta (style=”display:none”) ya que no nos interesa que el usuario la vea hasta que hayamos recibido el primer fichero.</p>

<p>Ahora que ya tenemos el formulario insertemos el JavaScript para que todo funcione (en la misma vista). Primero os pongo la metodología para el Helper y después el equivalente en HTML / JavaScript:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="cp">&lt;?=</span>
<span class="nv">$uploadify</span><span class="o">-&gt;</span><span class="na">startUploader</span><span class="p">(</span>
  <span class="k">array</span><span class="p">(</span><span class="s1">'imageFile'</span> <span class="o">=&gt;</span> <span class="s1">'img/'</span><span class="p">),</span>
  <span class="k">array</span><span class="p">(</span><span class="s1">'imageFile'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'buttonText'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Cercar fitxers'</span><span class="p">,</span><span class="kc">true</span><span class="p">),</span>
    <span class="s1">'script'</span> <span class="o">=&gt;</span> <span class="s1">'upload/'</span> <span class="o">.</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">(),</span>
    <span class="s1">'fileExt'</span> <span class="o">=&gt;</span> <span class="s1">'*.jpg;*.jpeg;*.png;*.gif'</span><span class="p">,</span>
    <span class="s1">'fileDesc'</span> <span class="o">=&gt;</span> <span class="s1">'Fitxers d\\\'imatge'</span><span class="p">,</span>
    <span class="s1">'multi'</span> <span class="o">=&gt;</span> <span class="s1">'true'</span><span class="p">,</span>
    <span class="s1">'onError'</span> <span class="o">=&gt;</span> <span class="s1">'function (a, b, c, d) {
      if (d.status == 404) {
        alert(\'Could not find upload script. Use a path relative to: '</span> <span class="o">.</span> <span class="nb">getcwd</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'\');
      } else if (d.type === "HTTP") {
        alert(\'error \' + d.type + \': \' + d.status);
      } else if (d.type === "File Size") {
        alert(c.name + \' \' + d.type + \' Limit: \' + Math.round(d.sizeLimit / 1024) + \'KB\');
      } else {
        alert(\'error \' + d.type + \': \' + d.text);
      }
    }'</span><span class="p">,</span>
    <span class="s1">'onComplete'</span> <span class="o">=&gt;</span> <span class="s1">'function(evt, queueID, fileObj, response, data) {
      $("#uploaded").show();
      $("#uploaded #files").append(\''</span> <span class="o">.</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="na">image</span><span class="p">(</span><span class="s2">"thumb/'+response+'"</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;input type="text" value="\'+response+\'" /&gt;&lt;input type="hidden" value="\'+response+\'" /&gt;\');
    }'</span><span class="p">,</span>
    <span class="s1">'onAllComplete'</span> <span class="o">=&gt;</span> <span class="s1">'function(){
      $("input[type=\\\'submit\\\']").removeAttr("disabled");
    }'</span>
  <span class="p">))</span>
<span class="p">);</span> <span class="cp">?&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Equivalente en JavaScript:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#imageFile'</span><span class="p">).</span><span class="nx">fileUpload</span> <span class="p">({</span>
    <span class="s1">'uploader'</span> <span class="p">:</span> <span class="s1">'/js/uploadify/uploader.swf'</span><span class="p">,</span>
    <span class="s1">'script'</span> <span class="p">:</span> <span class="s1">'upload/&lt;?= $session-&gt;id() ?&gt;'</span><span class="p">,</span>
    <span class="s1">'buttonText'</span> <span class="p">:</span> <span class="s1">'Cercar fitxers'</span><span class="p">,</span>
    <span class="s1">'onError'</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'Could not find upload script. Use a path relative to: &lt;?= getcwd() ?&gt;'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'HTTP'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'error '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'File Size'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">' Limit: '</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">sizeLimit</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'KB'</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s1">'error '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">'onComplete'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">queueID</span><span class="p">,</span> <span class="nx">fileObj</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#uploaded'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#uploaded #files'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;img src="/img/thumb/'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" alt="" /&gt;&lt;input type="text" value="'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" /&gt;&lt;input type="hidden" value="'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" /&gt;'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">'onAllComplete'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(){</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">"input[type='submit']"</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">'cancelImg'</span> <span class="p">:</span> <span class="s1">'/js/uploadify/cancel.png'</span><span class="p">,</span>
    <span class="s1">'fileExt'</span> <span class="p">:</span> <span class="s1">'*.jpg;*.jpeg;*.png;*.gif'</span><span class="p">,</span>
    <span class="s1">'fileDesc'</span> <span class="p">:</span> <span class="s1">'Fitxers d\'imatge'</span><span class="p">,</span>
    <span class="s1">'multi'</span> <span class="p">:</span> <span class="s1">'true'</span><span class="p">,</span>
    <span class="s1">'folder'</span><span class="p">:</span> <span class="s1">'img/'</span>
  <span class="p">});</span>
<span class="p">});</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>Sobre todo fijaros en que le paso como segundo parámetro a la url “upload” la id de la sesión actual. Esto junto con el beforeFilter del controlador puede ser vital para que os funcione correctamente uploadify con Cake.</p>

<p>He declarado tres funciones a ejecutar con uploadify: <em>onError</em>, <em>onComplete</em> y <em>onAllComplete</em>. La primera es por si sucede algún error con la carga del fichero, es simplemente para depuración pero nunca está de más tenerlo. Una vez os funcione correctamente la subida de ficheros podéis eliminarlo sin miedo alguno.</p>

<p>La función <em>onComplete</em> se encarga de hacer visible la capa “uploaded” y de ir insertando en ella las miniaturas de las imágenes que se vayan subiendo (ubicadas en la carpeta /webroot/img/thumb/). A demás de insertar las imágenes genera un textbox con el nombre del fichero, para que el usuario pueda poner el nombre deseado y un campo oculto con el nombre del fichero (para poder guardar su ruta en la base de datos).</p>

<p>Finalmente la función <em>onAllComplete</em> se encarga de eliminar el atributo “disabled” del botón de envío del formulario.
<a name="ampliacio"></a>
Aquí tenéis la vista al completo con el helper:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="cp">&lt;?=</span> <span class="nv">$uploadify</span><span class="o">-&gt;</span><span class="na">startUploader</span><span class="p">(</span>
  <span class="k">array</span><span class="p">(</span><span class="s1">'imageFile'</span> <span class="o">=&gt;</span> <span class="s1">'img/'</span><span class="p">),</span>
  <span class="k">array</span><span class="p">(</span><span class="s1">'imageFile'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'buttonText'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Cercar fitxers'</span><span class="p">,</span><span class="kc">true</span><span class="p">),</span>
    <span class="s1">'script'</span> <span class="o">=&gt;</span> <span class="s1">'upload/'</span> <span class="o">.</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">(),</span>
    <span class="s1">'fileExt'</span> <span class="o">=&gt;</span> <span class="s1">'*.jpg;*.jpeg;*.png;*.gif'</span><span class="p">,</span>
    <span class="s1">'fileDesc'</span> <span class="o">=&gt;</span> <span class="s1">'Fitxers d\\\'imatge'</span><span class="p">,</span>
    <span class="s1">'multi'</span> <span class="o">=&gt;</span> <span class="s1">'true'</span><span class="p">,</span>
    <span class="s1">'onError'</span> <span class="o">=&gt;</span> <span class="s1">'function (a, b, c, d) {
      if (d.status == 404) {
        alert(\'Could not find upload script. Use a path relative to: '</span> <span class="o">.</span> <span class="nb">getcwd</span><span class="p">()</span> <span class="o">.</span> <span class="s1">'\');
      } else if (d.type === "HTTP") {
        alert(\'error \' + d.type + \': \' + d.status);
      } else if (d.type === "File Size") {
        alert(c.name + \' \' + d.type + \' Limit: \' + Math.round(d.sizeLimit / 1024) + \'KB\');
      } else alert(\'error \' + d.type + \': \' + d.text);
    }'</span><span class="p">,</span>
    <span class="s1">'onComplete'</span> <span class="o">=&gt;</span> <span class="s1">'function(evt, queueID, fileObj, response, data){
      $("#uploaded").show();
      $("#uploaded #files").append(\''</span> <span class="o">.</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="na">image</span><span class="p">(</span><span class="s2">"thumb/' + response + '"</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'&lt;input type="text" value="\' + response + \'" /&gt;&lt;input type="hidden" value="\' + response + \'" /&gt;\');
    }'</span><span class="p">,</span>
    <span class="s1">'onAllComplete'</span> <span class="o">=&gt;</span> <span class="s1">'function(){
      $("input[type=\\\'submit\\\']").removeAttr("disabled");
    }'</span>
  <span class="p">))</span>
<span class="p">);</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;h2&gt;</span><span class="cp">&lt;?php</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Pujar imatges'</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/h2&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'Image'</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'add'</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"imageFile"</span><span class="nt">&gt;</span><span class="cp">&lt;?php</span> <span class="nx">__</span><span class="p">(</span><span class="s2">"Necessites JavaScript i Flash per poder pujar fitxers"</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"uploaded"</span> <span class="na">style=</span><span class="s">"display:none"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"files"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">submit</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s2">"Guardar"</span><span class="p">,</span><span class="kc">true</span><span class="p">));</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$html</span><span class="o">-&gt;</span><span class="na">link</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s2">"Enviar"</span><span class="p">,</span><span class="kc">true</span><span class="p">),</span><span class="s1">'javascript:$("#imageFile").fileUploadStart()'</span><span class="p">);</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">()</span> <span class="cp">?&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Y con Javascript:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></td><td class="code"><pre><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s1">'text/javascript'</span><span class="o">&gt;</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">'#imageFile'</span><span class="p">).</span><span class="nx">fileUpload</span> <span class="p">({</span>
    <span class="s1">'uploader'</span> <span class="p">:</span> <span class="s1">'/js/uploadify/uploader.swf'</span><span class="p">,</span>
    <span class="s1">'script'</span> <span class="p">:</span> <span class="s1">'upload/&lt;?= $session-&gt;id() ?&gt;'</span><span class="p">,</span>
    <span class="s1">'buttonText'</span> <span class="p">:</span> <span class="s1">'Cercar fitxers'</span><span class="p">,</span>
    <span class="s1">'onError'</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s1">'Could not find upload script. Use a path relative to: &lt;?= getcwd() ?&gt;'</span><span class="p">);</span>
         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'HTTP'</span><span class="p">)</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s1">'error '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
         <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span><span class="s1">'File Size'</span><span class="p">)</span>
            <span class="nx">alert</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">' Limit: '</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">sizeLimit</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'KB'</span><span class="p">);</span>
         <span class="k">else</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">'error '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="s1">': '</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">text</span><span class="p">);},</span>
    <span class="s1">'onComplete'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">queueID</span><span class="p">,</span> <span class="nx">fileObj</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#uploaded'</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'#uploaded #files'</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">'&lt;img src="/img/thumb/'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" alt="" /&gt;&lt;input type="text" value="'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" /&gt;&lt;input type="hidden" value="'</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">'" /&gt;'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">'onAllComplete'</span> <span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">'input[type=\'submit\']'</span><span class="p">).</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s1">'disabled'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">'cancelImg'</span> <span class="p">:</span> <span class="s1">'/js/uploadify/cancel.png'</span><span class="p">,</span>
    <span class="s1">'fileExt'</span> <span class="p">:</span> <span class="s1">'*.jpg;*.jpeg;*.png;*.gif'</span><span class="p">,</span>
    <span class="s1">'fileDesc'</span> <span class="p">:</span> <span class="s1">'Fitxers d\'imatge'</span><span class="p">,</span>
    <span class="s1">'multi'</span> <span class="p">:</span> <span class="s1">'true'</span><span class="p">,</span>
    <span class="s1">'folder'</span><span class="p">:</span> <span class="s1">'img/'</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;&lt;</span><span class="p">?</span><span class="nx">php</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Pujar imatges'</span><span class="p">)</span> <span class="p">?</span><span class="o">&gt;&lt;</span><span class="sr">/h2</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="p">?</span><span class="o">=</span> <span class="nx">$form</span><span class="o">-&gt;</span><span class="nx">create</span><span class="p">(</span><span class="s1">'Image'</span><span class="p">,</span> <span class="nx">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'add'</span><span class="p">))</span> <span class="p">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s1">'imageFile'</span><span class="o">&gt;&lt;</span><span class="p">?</span><span class="nx">php</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Necessites JavaScript i Flash per poder pujar fitxers'</span><span class="p">)</span> <span class="p">?</span><span class="o">&gt;&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s1">'uploaded'</span> <span class="nx">style</span><span class="o">=</span><span class="s1">'display:none'</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s1">'files'</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="p">?</span><span class="o">=</span> <span class="nx">$form</span><span class="o">-&gt;</span><span class="nx">submit</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Guardar'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span> <span class="p">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="p">?</span><span class="o">=</span> <span class="nx">$html</span><span class="o">-&gt;</span><span class="nx">link</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Enviar'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'javascript:$('</span><span class="err">#</span><span class="nx">imageFile</span><span class="s1">').fileUploadStart()'</span><span class="p">);</span> <span class="p">?</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="p">?</span><span class="o">=</span><span class="nx">$form</span><span class="o">-&gt;</span><span class="nx">end</span><span class="p">()</span> <span class="p">?</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Vale, recordemos un poco todo lo que hemos hecho para ver que no nos hemos dejado nada:</p>

<ul>
  <li>Hemos descargado jQuery y Uploadify</li>
  <li>Hemos guardado los ficheros que nos interesaban de ambas librerías en nuestro proyecto</li>
  <li>Hemos creado el controlador (/app/controllers/images_controller.php)”</li>
  <li>Hemos creado la vista (/app/view/images/add.ctp)</li>
  <li>Algo que no he dicho (pero que es bastante lógico..) es haber creado una carpeta donde se guardarán los ficheros, con permisos de escritura (755, 777… en sistemas UNIX/Linux)</li>
  <li>Tampoco he dicho que hay que crear un modelo (/app/models/image.php), pero si tenéis conocimientos de Cake seguro que ya lo sabíais ;)</li>
</ul>

<p>Para terminar os explicaré cómo funcionará el proceso de envío. Aquí tendría que hacer un diagrama de estados o algo así pero la verdad es que no apetece nada… :p</p>

<ul>
  <li>El usuario accederá a la página “images/add” y se le mostrará un botón con el que subir imágenes.</li>
  <li>Una vez seleccionado(s) el/los fichero(s) a subir, el usuario le da a “enviar” y se inicia la transferencia del éste.</li>
  <li>Una vez ha terminado el fichero y ha llegado correctamente al servidor, este/estos se procesan y en caso de éxito se devuelve el/los nombre(s) de fichero(s) resultante(s) al usuario. A partir de este/estos nombre(s) de fichero(s) nos encargaremos de que vea una(s) miniatura(s) de la(s) imagen(es) subida(s) (qué pesadito con el plural, eh?).</li>
  <li>A demás de las miniaturas le mostraremos un textbox al lado de cada una para que pueda poner el nombre si quiere.</li>
  <li>Cuando haya editado todos los nombres le dará al botón “guardar” que aparecerá a partir del primer fichero subido pero que no estará activo hasta que todos los ficheros hayan subido al servidor.</li>
  <li>Aquí hay una cosa que yo no hago en el ejemplo porque no me quiero complicar pero que creo conveniente que hagáis si no queréis llenar vuestro servidor de ficheros sin uso. Sería necesario guardar las rutas de ficheros una vez subidos por si el usuario no le diera a “guardar”. De éste modo podríais hacer un método con el que eliminar ficheros inutilizados fácilmente.</li>
</ul>

<p>Pues ahí lo tenéis. Creo que me ha salido una guía algo pobre :( es lo que tiene hacerla con algo de prisa… Cuando tenga algo más de tiempo intentaré colgar un ejemplo sobre esto.</p>

<blockquote style="text-align:center">
  <em><b>Si has terminado este tutorial satisfactoriamente mírate este otro: <a href="/2009/10/subida-de-ficheros-con-uploadify-y-validacion-ajax-en-cakephp">Subida de ficheros con Uploadify y validación Ajax en CakePHP</a></b></em>
</blockquote>

<p>Espero que no tengáis muchas dudas. De todos modos sabéis que estoy abierto a preguntas a través de los comentarios si os surge cualquier duda!</p>

<blockquote>
  Páginas de referencia:
  <ul>
    <li><a title="Documentación de uploadify" href="http://www.uploadify.com/documentation/" target="_blank">Uploadify documentation</a></li>
    <li><a title="Ver documentación de jQuery" href="http://docs.jquery.com/Main_Page" target="_blank">jQuery</a></li>
    <li><a title="Página del proyecto CakePHP" href="http://www.cakephp.org" target="_blank">CakePHP</a> | <a title="Documentación de CakePHP" href="http://book.cakephp.org/">Book</a> | <a title="API de CakePHP" href="http://api.cakephp.org/" target="_blank">API</a></li>
    <li><a title="Página del proyecto SWFUpload" href="http://swfupload.org" target="_blank">SWFUpload</a> | <a title="Documentación de SWFupload" href="http://swfupload.org/documentation" target="_blank">API</a> | <a title="Foros de swfupload" href="http://swfupload.org/forum" target="_blank">Foros</a></li>
    <li><a title="Buscar en Google" href="http://www.google.cat" target="_blank">Google</a> (cómo no..)</li>
  </ul>
</blockquote>

      <footer class="entry-meta">
        <span class="entry-tags">
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/PHP" title="Pages tagged PHP" class="tag">
                <span class="term">PHP</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/jQuery" title="Pages tagged jQuery" class="tag">
                <span class="term">jQuery</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/CakePHP" title="Pages tagged CakePHP" class="tag">
                <span class="term">CakePHP</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/Uploadify" title="Pages tagged Uploadify" class="tag">
                <span class="term">Uploadify</span>
            </a>
            
            
        </span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=//elboletaire.github.io/racotecnic/2009/06/subida-de-ficheros-en-cakephp-con-uploadify-y-jquery/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="//elboletaire.github.io/racotecnic/2009/06/illimitux-i-freerapid-downloader-fem-les-descarregues-mes-comodes/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="//elboletaire.github.io/racotecnic/2016/05/guarda-gratis-en-la-nube-tus-partidas-guardadas-o-como-hacer-copias-de-seguridad-en-la-nube-gratis/" title="Guarda GRATIS en la nube tus partidas guardadas o cómo hacer copias de seguridad en la nube gratis">Guarda GRATIS en la nube tus partidas guardadas o cómo hacer copias de seguridad en la nube gratis</a></h3>
      <p>Ya hace unos años que hago esto y la verdad es que es muy práctico. Consistebásicamente en subir automáticamente las partidas guardadas a...&hellip; <a href="//elboletaire.github.io/racotecnic/2016/05/guarda-gratis-en-la-nube-tus-partidas-guardadas-o-como-hacer-copias-de-seguridad-en-la-nube-gratis/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="//elboletaire.github.io/racotecnic/2015/03/instalacion-wamp-a-pelo-con-multiples-versiones-de-php/" title="Instalación WAMP a pelo con múltiples versiones de PHP o cómo configurar Apache para correr varias versiones de PHP en distintos servidores virtuales">Instalación WAMP a pelo con múltiples versiones de PHP o cómo configurar Apache para correr varias versiones de PHP en distintos servidores virtuales</a></h4>
        <span>Published on March 16, 2015</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="//elboletaire.github.io/racotecnic/2014/01/ordenar-por-columnas-en-laravel-4-o-como-extender-laravel-4-a-nuestro-gusto/" title="Ordenar por columnas en Laravel 4 o cómo extender Laravel 4 a tu gusto">Ordenar por columnas en Laravel 4 o cómo extender Laravel 4 a tu gusto</a></h4>
        <span>Published on January 18, 2014</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Racó Tècnic. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="//elboletaire.github.io/racotecnic/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="//elboletaire.github.io/racotecnic/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106861877-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'racotecnic'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</body>
</html>
