<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Integrando CakePHP y phpBB 3.x &#8211; Racó Tècnic</title>
<meta name="description" content="Punt de trobada de coneixements">
<meta name="keywords" content="PHP, phpBB, Administració usuaris, CakePHP, CakePHP 1.2">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="//elboletaire.github.io/racotecnic/images/">
<meta name="twitter:title" content="Integrando CakePHP y phpBB 3.x">
<meta name="twitter:description" content="Punt de trobada de coneixements">
<meta name="twitter:creator" content="@racotecnic">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Integrando CakePHP y phpBB 3.x">
<meta property="og:description" content="Punt de trobada de coneixements">
<meta property="og:url" content="//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/">
<meta property="og:site_name" content="Racó Tècnic">





<link rel="canonical" href="//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/">
<link href="//elboletaire.github.io/racotecnic/feed.xml" type="application/atom+xml" rel="alternate" title="Racó Tècnic Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="//elboletaire.github.io/racotecnic/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="//elboletaire.github.io/racotecnic/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="//elboletaire.github.io/racotecnic/assets/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="//elboletaire.github.io/racotecnic/assets/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="//elboletaire.github.io/racotecnic/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="//elboletaire.github.io/racotecnic/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="//elboletaire.github.io/racotecnic/images/" alt="Racó Tècnic photo" class="author-photo">
					<h4>Racó Tècnic</h4>
					<p>A subproject from <a href="http://underave.net">underave.net</a> created by <a href="https://github.com/elboletaire">elboletaire</a> and maintained by many collaborators.</p>
				</li>
				<li><a href="//elboletaire.github.io/racotecnic/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:elboletaire@underave.net"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/racotecnic"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/racotecnic"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				
				<li>
					<a href="https://github.com/elboletaire/racotecnic"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="//elboletaire.github.io/racotecnic/posts/">All Posts</a></li>
				<li><a href="//elboletaire.github.io/racotecnic/tags/">All Tags</a></li>
				<li><a href="//elboletaire.github.io/racotecnic/categories/">All Categories</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="https://github.com/elboletaire/racotecnic" target="_blank">Github</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/" rel="bookmark" title="Integrando CakePHP y phpBB 3.x">Integrando CakePHP y phpBB 3.x</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2010-01-23T15:32:41+01:00">January 23, 2010</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~49 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <style type="text/css">
  .amunt {
    float: right;
    font-size: .8em;
  }
  #registre-phpbb {
    width: 300px;
    -moz-border-radius: 7px;
    border: 1px solid #cccccc;
    float: left;
    background-color: #f7f7f7;
    margin: 20px 0;
  }
  #imatge-cakephp {
    float: right;
  }
</style>

<ul>
  <li><a href="#phpbb-zero">Antes de empezar</a></li>
  <li><a href="#phpbb-primer">Primeros pasos</a></li>
  <li><a href="#phpbb-segon">Creando el componente phpBB3</a></li>
  <li><a href="#phpbb-tercer">Registro de usuarios</a></li>
  <li><a href="#phpbb-quart">Errores fatales :s</a></li>
  <li><a href="#phpbb-cinque">Login de usuarios</a></li>
  <li><a href="#phpbb-sise">Cambio de datos del usuario</a></li>
  <li><a href="#phpbb-sete">Modificando vuestra plantilla de phpBB</a></li>
</ul>

<p><a href="//elboletaire.github.io/racotecnic/uploads/2010/01/hot-features.png" id="imatge-cakephp">
  <img class="alignnone size-full wp-image-1348" title="hot-features" src="//elboletaire.github.io/racotecnic/uploads/2010/01/hot-features.png" alt="" />
</a></p>

<h2 id="phpbb-zero">Antes de empezar…</h2>

<p>Más o menos al empezar con este blog expliqué cómo podíais <a title="Leer tutorial" href="http://www.racotecnic.com/2009/01/registro-de-usuarios-externo-a-phpbb-3x/" target="_self">hacer un registro de usuarios externo a phpBB3 con PHP</a>. Hoy voy a contaros cómo hacer para <strong>implementar el registro y login de usuarios de phpBB3 en CakePHP</strong>.</p>

<p>Podéis ver, como ejemplo, la página de <a href="http://www.underave.net">underave</a>. Pero os pido por favor que no os registréis si no vais a utilizar la cuenta.</p>

<p><strong>Antes de empezar</strong> con el tutorial, por favor, <strong>leeros el tutorial anterior</strong> sobre el <a title="Leer tutorial" href="http://www.racotecnic.com/2009/01/registro-de-usuarios-externo-a-phpbb-3x/" target="_self">registro de usuarios externo a phpBB3</a>, ya que habrá ciertos aspectos que pasaré por alto por estar explicados en ese tutorial.</p>

<p>Además de miraros ese tutorial deberíais echar un vistazo a la documentación del componente Auth, ya que sin él el registro de usuarios sería otra cosa…</p>

<ul>
  <li><a rel="nofollow" href="http://book.cakephp.org/view/172/authentication" target="_blank">CakePHP Authentication</a></li>
</ul>

<p>Como siempre, empiezo con lo que he utilizado para llevar a cabo el tutorial…</p>

<ul>
  <li><a rel="nofollow" href="http://www.cakephp.org/" target="_blank">CakePHP</a> (v. 1.2.4.8284 [1.2.5 stable])</li>
  <li>phpBB 3.0.2</li>
  <li>Componente de integración de phpBB3 (que ahora crearemos)</li>
</ul>

<p>Aunque yo haya utilizado la versión 3.0.2 de phpBB, debéis saber que <strong>este sistema debe funcionar igual de bien en cualquier versión de phpBB 3</strong> ;)</p>

<p>Parto de la base de que tenéis creado un modelo y un controlador encargados de gestionar los usuarios de vuestra aplicación Cake. En mi caso los he llamado “<em>users</em>”, aunque podéis llamarlos “usuarios”, “<em>members</em>”, o como os dé la gana.</p>

<p>Es decir, <strong>doy por supuesto que ya tenéis un sistema de usuarios funcionando en vuestra aplicación CakePHP</strong>. En este tutorial sólo os explicaré cómo integrar el registro y login de phpBB3, así que todo lo demás (validaciones de datos, creación de formularios, funcionamiento de la clase Auth…) quedará por supuesto (lo cual no quiere decir que no vaya a haber código al respecto ;)).</p>

<p><a id="more"></a><a id="more-1224"></a></p>

<h2 id="phpbb-primer">Primeros pasos</h2>

<p>Además de la parte encargada de la gestión de usuarios vamos a tener que crear un modelo para el foro. Este sólo debe contener el nombre del modelo y debemos indicarle que no va a utilizar base de datos:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// /app/models/forum.php
</span><span class="k">class</span> <span class="nc">Forum</span> <span class="k">extends</span> <span class="nx">AppModel</span>
<span class="p">{</span>
  <span class="k">var</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'Forum'</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$useDbConfig</span> <span class="o">=</span> <span class="s1">'forums'</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$useTable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Como podéis ver, además de haber indicado el nombre del modelo y haber desactivado el uso de base de datos en éste, he indicado que utilice la configuración de base de datos <em>forums</em>. Con esto indicamos al modelo que, en caso de utilizar la base de datos, la configuración que utilizaremos será la <em>forums</em>.</p>

<p>Podéis añadir tantas configuraciones de conexión a la base de datos como queráis, simplemente cread una variable con el nombre que queráis de conexión conteniendo los datos necesarios en el fichero <em>/app/config/database.php</em>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// /app/config/database.php
</span><span class="k">class</span> <span class="nc">DATABASE_CONFIG</span>
<span class="p">{</span>
  <span class="k">var</span> <span class="nv">$default</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'driver'</span>     <span class="o">=&gt;</span> <span class="s1">'mysql'</span><span class="p">,</span>
    <span class="s1">'persistent'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s1">'host'</span>       <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span>
    <span class="s1">'login'</span>      <span class="o">=&gt;</span> <span class="s1">'USUARIO'</span><span class="p">,</span>
    <span class="s1">'password'</span>   <span class="o">=&gt;</span> <span class="s1">'CONTRASEÑA'</span><span class="p">,</span>
    <span class="s1">'database'</span>   <span class="o">=&gt;</span> <span class="s1">'BASE_DE_DATOS'</span>
  <span class="p">);</span>
  <span class="k">var</span> <span class="nv">$forums</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'driver'</span>     <span class="o">=&gt;</span> <span class="s1">'mysql'</span><span class="p">,</span>
    <span class="s1">'persistent'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
    <span class="s1">'host'</span>       <span class="o">=&gt;</span> <span class="s1">'localhost'</span><span class="p">,</span>
    <span class="s1">'login'</span>      <span class="o">=&gt;</span> <span class="s1">'USUARIO'</span><span class="p">,</span>
    <span class="s1">'password'</span>   <span class="o">=&gt;</span> <span class="s1">'CONTRASEÑA'</span><span class="p">,</span>
    <span class="s1">'database'</span>   <span class="o">=&gt;</span> <span class="s1">'BASE_DE_DATOS'</span><span class="p">,</span>
    <span class="s1">'prefix'</span>     <span class="o">=&gt;</span> <span class="s1">'phpbb_'</span>
  <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Si vuestras tablas del foro tienen un prefijo (como es mi caso) aseguraros de especificar la opción “prefix” en el array de conexión a la base de datos.</p>

<h2 id="phpbb-segon">Creando el componente phpBB3</h2>

<p>Vamos a por la creación del componente PhpBB3 que nos permitirá el login de usuarios. El componente es una modificación de uno llamado <a rel="nofollow" href="http://bakery.cakephp.org/articles/view/phpbb3-api-bridge" target="_blank">PhpBB3 Api Bridge</a>, del <a rel="nofollow" href="http://bakery.cakephp.org" target="_blank">Bakery</a> the Cake.</p>

<p>He modificado el componente porque tal y como lo presenta <em>Wilson Sheldon</em> (el autor del componente), al iniciar sesión en el foro y si el usuario no existe, se le registra en el sistema.</p>

<p>Esto está muy bien cuando añadimos el foro <strong>después</strong> de haber creado nuestra aplicación CakePHP. Sin embargo, si en lugar de añadir el foro estamos creando un portal con CakePHP y con phpBB desde cero, lo más seguro es que no os interese hacer esa verificación.</p>

<p>Cread, pues, el componente <em>php_b_b3.php</em> con el siguiente contenido:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// /app/controllers/components/php_b_b3.php
</span><span class="sd">/**
* Created by Willson Sheldon =&gt; http://bakery.cakephp.org/articles/view/phpbb3-api-bridge
* Modified by Òscar Casajuana a.k.a. elboletaire =&gt; http://www.underave.net
*/</span>
<span class="k">class</span> <span class="nc">PhpBB3Component</span> <span class="k">extends</span> <span class="nx">Object</span>
<span class="p">{</span>

  <span class="k">var</span> <span class="nv">$controller</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$model</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$phpBBpath</span> <span class="o">=</span> <span class="s1">'/ruta/a/tu/instalacion/de/phpBB3/'</span><span class="p">;</span>

  <span class="sd">/**
   * Inicia la sesión en phpBB3
   * @param string $username
   * @param string $password
   * @param bool $remember [optional] Recordar entre sesiones
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$remember</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">auth</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span><span class="nv">$username</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$remember</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Cierra la sesión en phpBB
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">logout</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">session_kill</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">session_begin</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Registra un usuario en el sistema
   * @param array $data Datos del usuario
   * @return id del usuario en caso de éxito; falso en caso contrario
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Paràmetres per defecte
</span>    <span class="c1">// Grup usuaris registrats
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="c1">// Franja horària GMT+01
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_timezone'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_timezone'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_timezone'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// Horari d'estiu desactivat
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_dst'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_dst'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_dst'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_lang'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_lang'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_lang'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'es'</span><span class="p">;</span>
    <span class="c1">// Usuari inactiu per defecte
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// Això millor no tocar-ho
</span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_style'</span><span class="p">])</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_style'</span><span class="p">]))</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_style'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="nv">$userData</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'username'</span>        <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'username'</span><span class="p">],</span>
      <span class="s1">'username_clean'</span>  <span class="o">=&gt;</span> <span class="nb">strtolower</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span>
      <span class="s1">'user_password'</span>   <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">phpbb_hash</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'user_password'</span><span class="p">]),</span>
      <span class="s1">'user_email'</span>      <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_email'</span><span class="p">],</span>
      <span class="s1">'user_ip'</span>         <span class="o">=&gt;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REMOTE_ADDR'</span><span class="p">],</span>
      <span class="s1">'group_id'</span>        <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'group_id'</span><span class="p">],</span> <span class="c1">//Registered users group
</span>      <span class="s1">'user_timezone'</span>   <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_timezone'</span><span class="p">],</span>
      <span class="s1">'user_dst'</span>        <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_dst'</span><span class="p">],</span>
      <span class="s1">'user_lang'</span>       <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_lang'</span><span class="p">],</span>
      <span class="s1">'user_type'</span>       <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'user_type'</span><span class="p">],</span>
      <span class="s1">'user_actkey'</span>     <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
      <span class="s1">'user_dateformat'</span> <span class="o">=&gt;</span> <span class="s1">'D d M Y, g:i a'</span><span class="p">,</span>
      <span class="s1">'user_style'</span>      <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s1">'user_regdate'</span>    <span class="o">=&gt;</span> <span class="nb">time</span><span class="p">(),</span>
    <span class="p">);</span>
    <span class="nv">$userId</span> <span class="o">=</span> <span class="nx">user_add</span><span class="p">(</span><span class="nv">$userData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$userId</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Actualitzem darrer usuari registrat al phpBB
</span>      <span class="nx">update_last_username</span><span class="p">();</span>
      <span class="k">return</span> <span class="nv">$userId</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Encripta una contraseña utilizando el
   * método de encriptación de phpBB3
   * @param string $password
   * @return contraseña encriptada
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">phpbb_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">)</span>
  <span class="p">{</span>

    <span class="nv">$itoa64</span> <span class="o">=</span> <span class="s1">'./0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'</span><span class="p">;</span>
    <span class="nv">$random_state</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">unique_id</span><span class="p">();</span>
    <span class="nv">$random</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$count</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="nv">$fh</span> <span class="o">=</span> <span class="o">@</span><span class="nb">fopen</span><span class="p">(</span><span class="s1">'/dev/urandom'</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)))</span> <span class="p">{</span>
      <span class="nv">$random</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$fh</span><span class="p">,</span> <span class="nv">$count</span><span class="p">);</span>
      <span class="nb">fclose</span><span class="p">(</span><span class="nv">$fh</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$random</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$random</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$count</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$random_state</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">unique_id</span> <span class="p">()</span> <span class="o">.</span> <span class="nv">$random_state</span><span class="p">);</span>
        <span class="nv">$random</span> <span class="o">.=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'H*'</span><span class="p">,</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$random_state</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nv">$random</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$random</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$count</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$hash</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_hash_crypt_private</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_hash_gensalt_private</span><span class="p">(</span><span class="nv">$random</span><span class="p">,</span> <span class="nv">$itoa64</span><span class="p">),</span> <span class="nv">$itoa64</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$hash</span><span class="p">)</span> <span class="o">==</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$hash</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Verifica la existencia de un usuario
   * @param string $username
   * @return
   */</span>
  <span class="k">public</span> <span class="k">function</span> <span class="nf">userExists</span><span class="p">(</span><span class="nv">$username</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">user_get_id_name</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nv">$username</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'NO_USERS'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Carga los ficheros necesarios de phpBB3
   */</span>
  <span class="k">function</span> <span class="nf">startup</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$controller</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">controller</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$controller</span><span class="p">;</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'IN_PHPBB'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="k">global</span> <span class="nv">$phpbb_root_path</span><span class="p">,</span> <span class="nv">$phpEx</span><span class="p">,</span> <span class="nv">$db</span><span class="p">,</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$user</span><span class="p">,</span> <span class="nv">$auth</span><span class="p">,</span> <span class="nv">$cache</span><span class="p">,</span> <span class="nv">$template</span><span class="p">;</span>

    <span class="nv">$phpbb_root_path</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">phpBBpath</span><span class="p">;</span>
    <span class="nv">$phpEx</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nb">strrchr</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">require_once</span><span class="p">(</span><span class="nv">$phpbb_root_path</span> <span class="o">.</span> <span class="s1">'common.'</span> <span class="o">.</span> <span class="nv">$phpEx</span><span class="p">);</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">table_prefix</span> <span class="o">=</span> <span class="nv">$table_prefix</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">auth</span> <span class="o">=</span> <span class="nv">$auth</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span> <span class="o">=</span> <span class="nv">$user</span><span class="p">;</span>

    <span class="c1">// Start session management
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">session_begin</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">auth</span><span class="o">-&gt;</span><span class="na">acl</span><span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">setup</span><span class="p">();</span>

    <span class="k">require_once</span><span class="p">(</span><span class="nv">$phpbb_root_path</span> <span class="o">.</span><span class="s1">'includes/functions_user.php'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">private</span> <span class="k">function</span> <span class="nf">unique_id</span><span class="p">(</span><span class="nv">$extra</span> <span class="o">=</span> <span class="s1">'c'</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">static</span> <span class="nv">$dss_seeded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">global</span> <span class="nv">$config</span><span class="p">;</span>

    <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$config</span> <span class="p">[</span><span class="s1">'rand_seed'</span><span class="p">]</span> <span class="o">.</span> <span class="nb">microtime</span><span class="p">();</span>
    <span class="nv">$val</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$val</span><span class="p">);</span>
    <span class="nv">$config</span><span class="p">[</span><span class="s1">'rand_seed'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$config</span><span class="p">[</span><span class="s1">'rand_seed'</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$val</span> <span class="o">.</span> <span class="nv">$extra</span><span class="p">);</span>

    <span class="nv">$dss_seeded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$val</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Generate salt for hash generation
   */</span>
  <span class="k">private</span> <span class="k">function</span> <span class="nf">_hash_gensalt_private</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$itoa64</span><span class="p">,</span> <span class="nv">$iteration_count_log2</span> <span class="o">=</span> <span class="mi">6</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$iteration_count_log2</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="nv">$iteration_count_log2</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$iteration_count_log2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">'$H$'</span><span class="p">;</span>
    <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$itoa64</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nv">$iteration_count_log2</span> <span class="o">+</span> <span class="p">((</span><span class="k">PHP_VERSION</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">30</span><span class="p">)];</span>
    <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_hash_encode64</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nv">$itoa64</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**
   * Encode hash
   */</span>
  <span class="k">private</span> <span class="k">function</span> <span class="nf">_hash_encode64</span><span class="p">(</span><span class="nv">$input</span><span class="p">,</span> <span class="nv">$count</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$itoa64</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nv">$value</span> <span class="o">=</span> <span class="nb">ord</span> <span class="p">(</span><span class="nv">$input</span><span class="p">[</span><span class="nv">$i</span><span class="o">++</span><span class="p">]);</span>
      <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$itoa64</span><span class="p">[</span><span class="nv">$value</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$value</span> <span class="o">|=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$input</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$itoa64</span><span class="p">[(</span><span class="nv">$value</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">++</span> <span class="o">&gt;=</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$value</span> <span class="o">|=</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$input</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$itoa64</span><span class="p">[(</span><span class="nv">$value</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">++</span> <span class="o">&gt;=</span> <span class="nv">$count</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$itoa64</span><span class="p">[(</span><span class="nv">$value</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$count</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**
   * The crypt function/replacement
   */</span>
  <span class="k">private</span> <span class="k">function</span> <span class="nf">_hash_crypt_private</span><span class="p">(</span><span class="nv">$password</span><span class="p">,</span> <span class="nv">$setting</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$itoa64</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="s1">'*'</span><span class="p">;</span>

    <span class="c1">// Check for correct hash
</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$setting</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'$H$'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$count_log2</span> <span class="o">=</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$itoa64</span><span class="p">,</span> <span class="nv">$setting</span> <span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$count_log2</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="nv">$count_log2</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nv">$count_log2</span><span class="p">;</span>
    <span class="nv">$salt</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$setting</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$salt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="sd">/**
     * We're kind of forced to use MD5 here since it's the only
     * cryptographic primitive available in all versions of PHP
     * currently in use.  To implement our own low-level crypto
     * in PHP would result in much worse performance and
     * consequently in lower iteration counts and hashes that are
     * quicker to crack (by non-PHP code).
     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">PHP_VERSION</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$salt</span> <span class="o">.</span> <span class="nv">$password</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$hash</span> <span class="o">=</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$hash</span> <span class="o">.</span> <span class="nv">$password</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nv">$count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$hash</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'H*'</span><span class="p">,</span> <span class="nb">md5</span> <span class="p">(</span><span class="nv">$salt</span> <span class="o">.</span> <span class="nv">$password</span><span class="p">));</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$hash</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">'H*'</span><span class="p">,</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$hash</span> <span class="o">.</span> <span class="nv">$password</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nv">$count</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$output</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$setting</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="nv">$output</span> <span class="o">.=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_hash_encode64</span><span class="p">(</span><span class="nv">$hash</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="nv">$itoa64</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Aunque veáis mucho código, no os asustéis. La mayoría de estos métodos son para encriptar la contraseña. Los métodos que nosotros utilizaremos serán <strong>login</strong>, <strong>logout</strong>, <strong>register</strong> y <strong>userExists</strong>.</p>

<p>Lo primero que debéis hacer es substituir la ruta hacia vuestra instalación de phpBB3, en la <strong>línea 11</strong> (subrayada en azul, como no).</p>

<h2 id="phpbb-tercer">Registro de usuarios</h2>

<p>Ahora que ya tenemos el componente vamos a empezar a desarrollar el registro de usuarios. En esta parte editaremos / crearemos tres ficheros: el modelo de usuarios, para añadir las validaciones correspondientes; el controlador de usuarios, para añadir el método de registro y la vista del registro de usuarios.</p>

<p>Los usuarios los registraremos activados para ahorrarnos complicaciones. Dejo en vuestras manos la creación de un método para la activación de la cuenta del usuario en caso de que registréis a vuestros usuarios con la cuenta inhabilitada.</p>

<p>Empecemos con la vista <strong>register.ctp</strong>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'register'</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.username'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Nombre de usuario'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)))</span> <span class="cp">?&gt;</span>
<span class="c">&lt;!-- Indicamos value = '' a la contraseña para que no se rellene el campo automáticamente en caso de haber algún error en los datos --&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.password'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">,</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.confirm_passwd'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Confirma la contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">,</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.email'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'E-mail'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)))</span> <span class="cp">?&gt;</span>
<span class="cp">&lt;?=</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Registrarse'</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="cp">?&gt;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Sencillo, ¿no?</p>

<p>Creemos las validaciones que nos interesen en nuestro modelo <strong>user</strong>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre></td><td class="code"><pre><span class="cp">&lt;?php</span> <span class="c1">// /app/models/user.php
</span><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">AppModel</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'User'</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$validate</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'username'</span> <span class="o">=&gt;</span>  <span class="k">array</span><span class="p">(</span>
      <span class="s1">'length'</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'rule'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'between'</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'El nombre debe contener entre 3 y 23 caracteres'</span>
      <span class="p">),</span>
      <span class="s1">'exists'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'rule'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'checkUnique'</span><span class="p">,</span> <span class="s1">'username'</span><span class="p">),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'El nombre de usuario ya existe'</span>
      <span class="p">)</span>
    <span class="p">),</span>
    <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'El e-mail introducido no es válido'</span> <span class="o">=&gt;</span> <span class="nx">VALID_EMAIL</span><span class="p">,</span>
      <span class="s1">'El e-mail es obligatorio'</span>           <span class="o">=&gt;</span> <span class="nx">VALID_NOT_EMPTY</span><span class="p">,</span>
      <span class="s1">'exists'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'rule'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'checkUnique'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Ya hay un usuario registrado con este e-mail'</span>
      <span class="p">)</span>
    <span class="p">),</span>
    <span class="s1">'confirm_passwd'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'identicalFieldValues'</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'rule'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'identicalFieldValues'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Las contraseñas introducidas no coinciden'</span>
      <span class="p">)</span>
    <span class="p">),</span>
    <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">'length'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'rule'</span>    <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'minLength'</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'La contraseña debe contener al menos 6 caracteres'</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="p">);</span>

  <span class="sd">/**
  * Verifica si dos campos son iguales
  */</span>
  <span class="k">function</span> <span class="nf">identicalFieldValues</span><span class="p">(</span><span class="nv">$field</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$compare_field</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$field</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$v1</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">;</span>
      <span class="nv">$v2</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">][</span><span class="nv">$compare_field</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$v1</span> <span class="o">!==</span> <span class="nv">$v2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">TRUE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**
  * Verifica si un dato existe en la base de datos
  * @param $data         Dato con el que comparar
  * @param $fieldName    Nombre de celda a verificar
  * @return bool
  */</span>
  <span class="k">function</span> <span class="nf">checkUnique</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$fieldName</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasField</span><span class="p">(</span><span class="nv">$fieldName</span><span class="p">))</span> <span class="p">{</span>
      <span class="nv">$valid</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">isUnique</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$fieldName</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$valid</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>Los métodos <strong>identicalFieldValues</strong> y <strong>checkUnique</strong> son los encargados de verificar si las dos contraseñas coinciden y si el usuario existe en la base de datos.</p>

<p>Si tenéis cualquier duda sobre la creación del modelo podéis dirigiros a la documentación de cake al respecto, ya que allí se explica todo con detalle:</p>

<ul>
  <li><a rel="nofollow" href="http://book.cakephp.org/view/125/Data-Validation" target="_blank">CakePHP Data Validation</a></li>
  <li><a rel="nofollow" href="http://book.cakephp.org/view/150/Custom-Validation-Rules" target="_blank">CakePHP Custom Validation Rules</a></li>
</ul>

<p>Vamos a por el método <strong>register</strong>. Este puede variar mucho según la aplicación que queráis hacer… por ejemplo, en el caso de <a href="http://www.underave.net">underave</a> verifico que el usuario no está registrado ni en el foro ni en la página principal, ya que cuando hicimos el cambio cometimos el error de hacerlo así. En el ejemplo doy por supuesto que si el usuario no existe en la base de datos principal, no existirá en el foro. De todos modos veréis cómo hacer para verificar la existencia de un usuario (todo el primer trozo comentado):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// /app/controllers/users_controller.php
</span><span class="k">class</span> <span class="nc">UsersController</span> <span class="k">extends</span> <span class="nx">AppController</span>
<span class="p">{</span>
  <span class="k">var</span> <span class="nv">$name</span> <span class="o">=</span> <span class="s1">'Users'</span><span class="p">;</span>
  <span class="k">var</span> <span class="nv">$components</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'Auth'</span><span class="p">,</span> <span class="s1">'PhpBB3'</span><span class="p">);</span>

  <span class="k">function</span> <span class="nf">register</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">pageTitle</span> <span class="o">=</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Registro'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="o">.</span> <span class="s1">' | '</span> <span class="o">.</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Usuarios'</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Guardamos la contraseña sin encriptar para registrar al usuario en el foro
</span>      <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'confirm_passwd'</span><span class="p">];</span>
<span class="c1">//      Si nos interesa, verificamos la existencia del usuario en el foro
//      if($this-&gt;phpBB-&gt;userExists($this-&gt;data['User']['username']))
//        $this-&gt;User-&gt;invalidate('username','exists');
</span>      <span class="c1">// Cargamos los datos del usuario en el modelo
</span>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
      <span class="c1">// En caso de pasar las validaciones...
</span>      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">validates</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// Registramos el usuario en el foro
</span>        <span class="nv">$datos</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
          <span class="s1">'username'</span>      <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'username'</span><span class="p">],</span>
          <span class="s1">'user_password'</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">,</span>
          <span class="s1">'user_email'</span>    <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'email'</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$userForumId</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PhpBB3</span><span class="o">-&gt;</span><span class="na">register</span><span class="p">(</span><span class="nv">$datos</span><span class="p">))</span> <span class="p">{</span>
          <span class="c1">// En caso de haber registrado al usuario correctamente guardamos la variable con su id del foro
</span>          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'forum_id'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$userForumId</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Usuario registrado correctamente'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s1">'/'</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Ha habido algún error al registrarte...'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Ha habido algún error al registrarte...'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Como podéis ver en el ejemplo, una vez he registrado al usuario en el foro me quedo con la ID del usuario creado y es entonces cuando registro al usuario en el sistema, para poder disponer de esta ID.</p>

<p>Si no guardáis la ID del usuario en vuestra base de datos de Cake no podréis hacer nada una vez registrado el usuario. Es decir, no podréis hacer ni el login, ni un cambio de contraseña ni nada de nada. Así que es vital que guardéis su ID.</p>

<p>Bien, en principio esta parte ya la tenemos. Ahora mismo al registrarse alguien en vuestro sistema queda registrado en el foro y en la base de datos de CakePHP.</p>

<p>Ap!! Pero alto, si lo probáis no funcionará. Adelante, haced la prueba. Es necesaria para seguir adelante.</p>

<h2 id="phpbb-quart">Errores fatales :s</h2>

<p>Si estáis utilizando caché, lo más seguro es que el primer error que veáis sea este:</p>

<blockquote>
  <p><strong>Fatal error:</strong> Cannot redeclare class cache in …</p>
</blockquote>

<p>Esto sucede porque el núcleo de Cake utiliza una classe que se llama igual que una del núcleo de phpBB3 (cache, en este caso). Estuve varios meses dándole vueltas a este asunto y la mejor solución que encontré fue modificar algunos ficheros de phpBB3, así que vamos a ello. No os preocupéis, tan solo modificaremos unos pocos ficheros:</p>

<p>Básicamente lo que hay que hacer es renombrar la clase <strong>cache</strong>. Primero modificaremos el nombre de la clase y luego pasaremos a cambiar aquellas líneas de código donde se instancíe la clase.</p>

<p>Abrid <em>phpBB3/includes/cache.php</em> y buscad lo siguiente (en la línea 23 aproximadamente):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">cache</span> <span class="k">extends</span> <span class="nx">acm</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Substituidlo por:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">fcache</span> <span class="k">extends</span> <span class="nx">acm</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Guardad el fichero y cerradlo. Ahora abrid estos ficheros:</p>

<ul>
  <li><em>phpBB3/common.php</em></li>
  <li><em>phpBB3/style.php</em></li>
  <li><em>phpBB3/download/file.php</em></li>
</ul>

<p>Buscad esto en cada uno de ellos:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">new</span> <span class="nx">cache</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Y reemplazadlo por:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">new</span> <span class="nx">fcache</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Hecho esto (y una vez guardados los ficheros, por supuesto..) subís los ficheros al servidor y el foro debería seguir funcionando correctamente.</p>

<p>¡Aps! ¿Que no os funciona correctamente? Si, como yo, habéis creado el sistema de usuarios utilizando la palabra “users”, tendréis otro error fatal:</p>

<blockquote>
  <p><strong>Fatal error:</strong> Cannot redeclare class user…</p>
</blockquote>

<p>Del mismo modo que con la caché, la mejor forma de solucionar esto es modificando phpBB3. Abrid el fichero phpBB3/includes/session.php y buscad lo siguiente (en la línea 1376 aproximadamente):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">user</span> <span class="k">extends</span> <span class="nx">session</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Y reemplazadlo por…</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">class</span> <span class="nc">fuser</span> <span class="k">extends</span> <span class="nx">session</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Ahora abrid el fichero <em>phpBB3/common.php</em> y buscad lo siguiente:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">new</span> <span class="nx">user</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Y reemplazadlo por:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="k">new</span> <span class="nx">fuser</span><span class="p">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Ahora sí que sí :D. Vuestro registro de usuarios, así como vuestra instalación de phpBB, deberían funcionar perfectamente ;)</p>

<h2 id="phpbb-cinque">Login de usuarios</h2>

<p>Bien, ahora pasaremos a la creación de la vista <strong>login.ctp</strong>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="cp">&lt;?php</span>
<span class="c1">// /app/views/users/login.ctp
</span><span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'login'</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.username'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Nombre'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
<span class="c1">// Utilizamos 'pass' para que Auth no nos encripte la contraseña automáticamente
</span><span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.pass'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span> <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">));</span>
<span class="c1">// Guardamos el referer para saber si el usuario viene del foro y así poderle enviar de nuevo al finalizar el login
</span><span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">hidden</span><span class="p">(</span><span class="s1">'User.referer'</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="o">@</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'HTTP_REFERER'</span><span class="p">]));</span>
<span class="c1">// Nota: Recordar entre sesiones funciona en el foro. Si no tenéis algún componente o método para recordar sesiones en Cake, quizás os interese utilizar alguno.
</span><span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'User.remember_me'</span><span class="p">,</span><span class="k">array</span><span class="p">(</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'checkbox'</span><span class="p">,</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Recordar entre sesiones'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Iniciar sesión'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Es importante que guardemos la contraseña con un nombre de campo distinto a <em>password</em> ya que necesitamos la contraseña sin encriptar para poder iniciar sesión en el foro.</p>

<p>Pasemos al método <em>login</em> de nuestro controlador de usuarios. Ya que estamos, también añadiremos el de <em>logout</em>:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="c1">// /app/controllers/users_controller.php
</span><span class="k">function</span> <span class="nf">login</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Guardamos la contraseña encriptada para iniciar sesión en Cake
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'pass'</span><span class="p">]);</span>
    <span class="c1">// Iniciamos sesión en Cake
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Iniciamos sesión en PhpBB. Si tenemos el campo 'remember_me' se lo pasamos como tercer parámetro.
</span>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PhpBB3</span><span class="o">-&gt;</span><span class="na">login</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'username'</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'pass'</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'remember_me'</span><span class="p">]);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="s1">'Sessió iniciada correctament'</span><span class="p">,</span><span class="s1">'flash_info'</span><span class="p">,</span><span class="k">array</span><span class="p">(),</span><span class="s1">'auth'</span><span class="p">);</span>
      <span class="c1">// Verifico si el usuario viene del dominio principal
</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/^http:\/\/(www\.)?underave\.net/'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'referer'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'referer'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="c1">// Limpio la URL de posibles ids de sesión del foro (para evitar que éste cierre la sesión por seguridad)
</span>        <span class="nv">$referer</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'/^(.+)sid=[0-9a-z]+/i'</span><span class="p">,</span> <span class="s1">'$1'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'referer'</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="c1">// Si viene del dominio principal lo redirigiremos con el método Auth-&gt;redirect()
</span>      <span class="k">else</span> <span class="nv">$referer</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">();</span>

      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$referer</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">logout</span><span class="p">()</span>
<span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">PhpBB3</span><span class="o">-&gt;</span><span class="na">logout</span><span class="p">();</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">logout</span><span class="p">());</span>
<span class="p">}</span>

</pre></td></tr></tbody></table>
</div>
</div>

<p>En las <strong>líneas 13 a 17</strong> lo que hago es verificar si el usuario viene de mi dominio principal. Lo hago así porque en mi caso tengo los foros en un subdominio. Si no es vuestro caso deberéis modificar la expresión regular para que se ajuste a vuestras necesidades.</p>

<p>Si, como yo, tenéis los foros en un subdominio debéis saber que necesitáis tener las cookies configuradas para que funcionen entre vuestros subdominios y vuestro dominio principal. Para hacerlo, primero de todo id a vuestro panel de control del foro. En la barra lateral de la pestaña “General” veréis un grupo de opciones: “Configuración del servidor”. Ahí dentro tenéis un enlace para acceder a la configuración de las cookies.</p>

<p>Dentro de esta configuración, debéis poner como dominio de las cookies un punto seguido de vuestro nombre de dominio. En mi caso <strong>.underave.net</strong>. El punto delante del dominio es importante porque algunos navegadores no reconocerían los subdominios sin él.</p>

<p>En directorio de la cookie aseguraros que apunta a la raíz del dominio: <strong>/</strong></p>

<p>Ahora debéis aseguraros que en vuestro php.ini (o utilizando el método php ini_set) tenéis las cookies también configuradas como en el foro:</p>

<p>[sourcecode language=”plain”]; The path for which the cookie is valid.
session.cookie_path = /
; The domain for which the cookie is valid.
session.cookie_domain = .underave.net[/sourcecode]</p>

<p>Hecho esto y subido vuestro php.ini al servidor (antes de subirlo quizás os interese echar un ojo al resto de opciones para ver qué se cuece por ahí) el login de usuarios ya debe funcionar sin problema alguno :)</p>

<h2 id="phpbb-sise">Y si el usuario quisiera cambiar alguno de sus datos?</h2>

<p>A mi parecer, es importante que el usuario no tenga que actualizar sus datos varias veces. Es decir, si el usuario cambia su e-mail o su contraseña desde nuestra aplicación Cake, es importante que éste dato se actualice también en el foro.</p>

<p>Además, sería interesante modificar todos los enlaces de phpBB del perfil de usuario que tengan que ver con la edición de datos personales para que éstos enlacen hacia nuestra aplicación Cake.</p>

<p>Si antes he creado una conexión hacia nuestra base de datos de phpBB así como un modelo llamado <em>Forum</em> ha sido porque a partir de ahora trabajaremos con la base de datos en lugar de con el componente. ¿Porqué? Porque así veis que todo esto que hemos estado haciendo es posible hacerlo sin utilizar los métodos del núcleo de phpBB3. ¿Todo? Bueno no, todo no. Para el login de usuarios seguramente será necesario que utilicéis el componente (a no ser que intentéis crear a mano las cookies vosotros mismos).</p>

<p>El método que crearemos ahora será para cambiar la contraseña ya que el cambio de contraseña quizás sea de los datos del perfil más difíciles de modificar. Después de ver el ejemplo añadid tantos métodos como necesitéis (cambio de e-mail, de avatar …).</p>

<p>Para cambiar cualquier dato de los usuarios del foro sería interesante tener un método en nuestro modelo Forum:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="c1">// /app/models/forum.php
</span><span class="sd">/**
 * Actualiza un dato ($field) de un usuario a
 * partir de su $id en el foro con el valor $value
 *
 * @param integer $id of user
 * @param string $field to update
 * @param mixed $value
 * @return boolean true on success, false on failure
 */</span>
<span class="k">function</span> <span class="nf">setUserField</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setSource</span><span class="p">(</span><span class="s1">'users'</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">primaryKey</span> <span class="o">=</span> <span class="s1">'user_id'</span><span class="p">;</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">=</span> <span class="nv">$id</span><span class="p">;</span>
  <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">saveField</span><span class="p">(</span><span class="nv">$field</span><span class="p">,</span> <span class="nv">$value</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Añadamos una vista para el cambio de contraseña:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre>// /app/views/users/change_password.ctp
<span class="cp">&lt;?php</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">'User'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'action'</span> <span class="o">=&gt;</span> <span class="s1">'changePassword'</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'old_passwd'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Contraseña actual'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">,</span><span class="s1">'type'</span><span class="p">,</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">,</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">input</span><span class="p">(</span><span class="s1">'confirm_passwd'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="nx">__</span><span class="p">(</span><span class="s1">'Confirma la contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'password'</span><span class="p">,</span><span class="s1">'value'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">));</span>
<span class="k">echo</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">end</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Cambiar contraseña'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Y aquí viene el método de cambiar contraseña (está creado en el controlador usuarios pero no estaría de más separarlo un poco entre modelo y controlador):</p>

<div class="language-php highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></td><td class="code"><pre><span class="c1">// /app/controllers/users_controller.php
</span><span class="k">function</span> <span class="nf">changePassword</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Buscamos el usuario actual en la base de datos
</span>    <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">findById</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">(</span><span class="s1">'id'</span><span class="p">));</span>
    <span class="c1">// Cargamos los datos en el modelo (para validarlos)
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">);</span>
    <span class="c1">// Encriptamos la contraseña antigua para validarla
</span>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'old_passwd'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'old_passwd'</span><span class="p">]);</span>
    <span class="c1">// Validamos y verificamos que la contraseña introducida coincide con la de la BDD
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">validates</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'old_passwd'</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">])</span> <span class="p">{</span>
      <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">];</span>
      <span class="c1">// Actualizamos la contraseña del foro
</span>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Forum</span><span class="o">-&gt;</span><span class="na">setUserField</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'forums_id'</span><span class="p">],</span> <span class="s1">'user_password'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Auth</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">]));</span>
      <span class="c1">// Actualizamos la contraseña del sistema
</span>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">updateAll</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'User.password'</span><span class="o">=&gt;</span><span class="s1">'''.$this-&gt;Auth-&gt;password($password).'''</span><span class="p">),</span><span class="k">array</span><span class="p">(</span><span class="s1">'User.id'</span><span class="o">=&gt;</span><span class="nv">$user</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'id'</span><span class="p">]));</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">Session</span><span class="o">-&gt;</span><span class="na">setFlash</span><span class="p">(</span><span class="nx">__</span><span class="p">(</span><span class="s1">'Tu contraseña ha sido cambiada con éxito'</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span><span class="s1">'flash_info'</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'controller'</span><span class="o">=&gt;</span><span class="s1">'users'</span><span class="p">,</span><span class="s1">'action'</span><span class="o">=&gt;</span><span class="s1">'profile'</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">// Si la contraseña no coincide con la guardada en la BDD mostramos error.
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">data</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'old_passwd'</span><span class="p">]</span> <span class="o">!=</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'User'</span><span class="p">][</span><span class="s1">'password'</span><span class="p">])</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">User</span><span class="o">-&gt;</span><span class="na">invalidate</span><span class="p">(</span><span class="s1">'old_passwd'</span><span class="p">,</span><span class="nx">__</span><span class="p">(</span><span class="s1">'La contraseña no es correcta'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Con esto ya podéis cambiar la contraseña en todo el sistema y ya sabéis cómo hacer para modificar el resto de datos. Al actualizar la contraseña he utilizado <em>user_password</em> como nombre de celda. Consultad vuestra base de datos de phpBB para saber los nombres de las celdas a actualizar.</p>

<p>Si quisierais utilizar la vía del componente y así no tener que utilizar la base de datos y el modelo Forum tendríais que añadir un método en el componente PhpBB3 que actualizara la celda. Para crear dicho método podéis consultar la documentación de phpBB3:</p>

<blockquote>
  <ul>
    <li><a rel="nofollow" href="http://area51.phpbb.com/docs/code/" target="_blank">Especificaciones de métodos y clases de phpBB 3</a></li>
  </ul>
  <em>**Pista:** Seguramente necesitaréis utilizar la clase 'user' (cambiada por nosotros a fuser, recordad!!) y su método <a rel="nofollow" href="http://area51.phpbb.com/docs/code/phpBB3/user.html#optionset" target="_blank">optionset()</a>.</em>
</blockquote>

<h3 id="phpbb-sete">Modificando vuestra plantilla de phpBB</h3>

<p>Ahora sólo os faltaría modificar vuestra plantilla de phpBB para enlazar hacia vuestra aplicación Cake, con el registro de usuarios, el login y la edición de datos de vuestro perfil.</p>

<p>Podéis enlazar a ella o, en el caso de la edición de datos del perfil, tratar de modificar los formularios de phpBB para que envíen a la aplicación Cake y luego hacer algo como en el login con el referer para poder redirigir al usuario de nuevo al foro.</p>

<p>Esto lo dejo en vuestras manos dado que la solución es bastante abierta y ya llevo mucho rato <em>dándoos la tabarra</em>. Además, me parece que con las pistas que he dado ya tenéis más que suficiente para empezar ;)</p>

<p>Pues con esto creo que ya hemos terminado. Si veis cualquier fallo u os peta la aplicación por algún lado no dudéis en preguntar, comentar y despotricar sobre mí. Tened en cuenta que he modificado el código considerablemente (desde el propio Wordpress…) para tratar de simplificarlo y puede que me haya comido alguna línea o incluso hasta algún apartado entero (esperemos que no…).</p>

<p>En cuanto vea vuestros comentarios trataré de contestarlos :)</p>

      <footer class="entry-meta">
        <span class="entry-tags">
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/PHP" title="Pages tagged PHP" class="tag">
                <span class="term">PHP</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/phpBB" title="Pages tagged phpBB" class="tag">
                <span class="term">phpBB</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/Administració usuaris" title="Pages tagged Administració usuaris" class="tag">
                <span class="term">Administració usuaris</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/CakePHP" title="Pages tagged CakePHP" class="tag">
                <span class="term">CakePHP</span>
            </a>
            
            
            <a href="//elboletaire.github.io/racotecnic/etiqueta/CakePHP 1.2" title="Pages tagged CakePHP 1.2" class="tag">
                <span class="term">CakePHP 1.2</span>
            </a>
            
            
        </span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=//elboletaire.github.io/racotecnic/2010/01/integrando-cakephp-y-phpbb-3-x/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="//elboletaire.github.io/racotecnic/2010/01/adios-multipleie-hola-ietester/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="//elboletaire.github.io/racotecnic/2016/05/guarda-gratis-en-la-nube-tus-partidas-guardadas-o-como-hacer-copias-de-seguridad-en-la-nube-gratis/" title="Guarda GRATIS en la nube tus partidas guardadas o cómo hacer copias de seguridad en la nube gratis">Guarda GRATIS en la nube tus partidas guardadas o cómo hacer copias de seguridad en la nube gratis</a></h3>
      <p>Ya hace unos años que hago esto y la verdad es que es muy práctico. Consistebásicamente en subir automáticamente las partidas guardadas a...&hellip; <a href="//elboletaire.github.io/racotecnic/2016/05/guarda-gratis-en-la-nube-tus-partidas-guardadas-o-como-hacer-copias-de-seguridad-en-la-nube-gratis/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="//elboletaire.github.io/racotecnic/2015/03/instalacion-wamp-a-pelo-con-multiples-versiones-de-php/" title="Instalación WAMP a pelo con múltiples versiones de PHP o cómo configurar Apache para correr varias versiones de PHP en distintos servidores virtuales">Instalación WAMP a pelo con múltiples versiones de PHP o cómo configurar Apache para correr varias versiones de PHP en distintos servidores virtuales</a></h4>
        <span>Published on March 16, 2015</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="//elboletaire.github.io/racotecnic/2014/01/ordenar-por-columnas-en-laravel-4-o-como-extender-laravel-4-a-nuestro-gusto/" title="Ordenar por columnas en Laravel 4 o cómo extender Laravel 4 a tu gusto">Ordenar por columnas en Laravel 4 o cómo extender Laravel 4 a tu gusto</a></h4>
        <span>Published on January 18, 2014</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Racó Tècnic. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="//elboletaire.github.io/racotecnic/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="//elboletaire.github.io/racotecnic/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-106861877-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'racotecnic'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</body>
</html>
